# 后端架构设计说明（E:\Ai--\src）

> 技术栈：Python 3 + FastAPI + SQLAlchemy + Pydantic  
> 目标：为 AI 课程助手提供稳定的 REST API、AI 对话服务和课程/计划数据支撑，方便前端（Vue）和 LangGraph 等 AI 组件集成。

---

## 1. 整体结构

后端代码根目录：`E:\Ai--\src`

主要文件与目录：

- `src/main.py`：后端入口  
  - 加载 `.env` 配置。  
  - 配置 CORS（跨域）。  
  - 从 `app.main` 导入真正的 FastAPI 实例。  
  - 提供 `run()` 便于 `python -m main` 启动。

- `src/app/main.py`：应用工厂  
  - 创建 `FastAPI` 实例。  
  - 读取全局配置 `get_settings()`。  
  - 注册业务路由：
    - `auth`：`/api/auth/*`
    - `user`：`/api/user/*`
    - `course`：`/api/courses/*`
    - `assignment`：`/api/assignments/*`
    - `announcement`：`/api/announcements/*`
    - `schedule`：`/api/schedule/*`
    - `ai`：`/api/ai/*`

- `src/app/core`：核心基础设施  
  - `config.py`：`Settings` 配置类，从环境变量 /.env 读取：
    - APP 基础信息：`APP_NAME`、`APP_ENV`、`DEBUG`  
    - 数据库配置：`DATABASE_URL`  
    - AI 配置：`AI_MODEL`、`AI_TEMPERATURE`、`AI_API_BASE`、`AI_API_KEY`  
    - 语音配置：`VOICE_STT_API_KEY`、`VOICE_TTS_API_KEY`  
  - `database.py`：SQLAlchemy `engine`、`SessionLocal`、`Base` 定义，`get_db()` FastAPI 依赖。  
  - `LLMConfig.py`：基于 `Settings` 生成 `LLMConfig`（model、temperature、api_base、api_key），供 AI 模块使用。  
  - `security.py`：安全与认证：
    - JWT 生成与解析。  
    - 密码哈希校验。  
    - `get_current_user` 依赖，用于需要登录的接口。

- `src/app/models`：ORM 实体（数据库表映射）  
  - `user.py`：`User` 用户表。  
  - `course.py`：`Course`、`CourseEnrollment`、`Chapter`、`Lesson`。  
  - `assignment.py`：`Assignment`、`AssignmentSubmission`。  
  - `announcement.py`：`Announcement` 公告。  
  - `resource.py`：`FileResource`（课程文件资源）。  
  - `ai.py`：`AiConversation`、`AiMessage`（AI 会话与消息）。

- `src/app/routers`：HTTP 路由层（接口定义）  
  - `auth.py`：登录 / 注册 / 当前用户 `/api/auth/*`  
  - `user.py`：个人资料 `/api/user/profile`  
  - `course.py`：课程列表 / 详情 `/api/courses`  
  - `assignment.py`：作业列表 / 详情 / 提交 `/api/assignments/*`  
  - `announcement.py`：公告列表 `/api/announcements`  
  - `schedule.py`：课程表示例 `/api/schedule/sample`（未来会对接真实课程时间片）  
  - `ai.py`：AI 聊天、工具列表、工具调用 `/api/ai/*`

- `src/app/services`：服务层（业务逻辑）  
  - `auth_service.py`：用户注册、登录、JWT 生成与基本校验。  
  - `ai_chat_service.py`：AI 对话封装（基于 LLMConfig 和 Prompt / LangGraph）。

- `src/app/AI`：AI 能力模块  
  - `Promt/SetPromts.py`：课程助手系统提示词配置（LangChain PromptTemplate + 文本版）。  
  - `Graph/`：LangGraph 图定义（如课程助手图），封装 LLM 调用流程。  
  - `Chain/`：如需使用 LangChain 链式调用，可在此扩展。  
  - `Tool/NetTool`：网络搜索等 AI 工具，注册到全局 ToolRegistry。

- `src/app/Data/Entity`：DTO / 聚合实体（非 ORM）  
  - `ChatEntity`、`ChatRequestDTO`、`ChatReplyDTO`、`ChatResponse`：AI 对话输入输出结构。  
  - `CourseSlot`、`StudentSchedule`：课程表聚合实体。

- `src/app/TTS`：语音模块（预留）。  
- `src/app/Mcp`：MCP 相关集成（预留）。

---

## 2. 分层与职责

整体采用「路由层（接口） → 服务层（业务） → 模型层（数据） → AI 层（大模型与工具）」的分层结构。

### 2.1 路由层（Routers）

- 职责：
  - 定义 URL、HTTP 方法、请求和响应模型（Pydantic）。  
  - 进行基本的参数校验和权限校验。  
  - 调用服务层函数，不直接操作 ORM。
- 示例：
  - `auth.py`：
    - `POST /api/auth/login` 调用 `auth_service.login()`。  
    - `POST /api/auth/register` 调用 `auth_service.register_user()`。  
  - `ai.py`：
    - `POST /api/ai/chat` 将 HTTP DTO 转成 `ChatEntity`，调用 `ai_chat_service.generate_reply()`。

### 2.2 服务层（Services）

- 职责：
  - 实现「用例级」业务逻辑（Use Case），处理事务、组合多个模型和外部服务。  
  - 对外提供清晰的函数接口，隐藏 ORM 与第三方 SDK 的具体细节。
- 示例：
  - `auth_service`：
    - 注册：检查账号是否存在、写入 `User` 表、生成 JWT。  
    - 登录：验证密码、更新 last_login_at、生成 JWT。  
  - `ai_chat_service`：
    - 将 `ChatEntity` 转为 Prompt 输入（通过 `SetPromts.py`）。  
    - 调用 LangGraph 图或直接调用 LLM（依据 `LLMConfig`）。  
    - 将 LLM 返回封装成 `ChatResponse`，携带工具调用信息。

### 2.3 模型层（Models / ORM）

- 职责：
  - 与数据库表结构一一对应，提供字段定义和基本约束。  
  - 不负责复杂业务逻辑（只做数据存取）。
- 说明：
  - 当前项目已实现用户、课程、作业、公告、资源、AI 会话等模型。  
  - 后续可以根据 `数据库表设计.md` 补充计划相关模型（Plan / PlanTask / PlanDiary 等）。

### 2.4 核心基础设施层（Core）

- `config.py`：统一配置入口，避免到处直接读环境变量。  
- `database.py`：连接管理与事务控制。  
- `security.py`：JWT / 密码 / 当前用户解析，作为路由依赖使用。  
- `LLMConfig.py`：AI 调用配置集中管理，便于后续更换模型或网关。

### 2.5 AI 能力层（AI / Promt / Graph / Tool）

- Prompt 层（Promt）：
  - 将课程助手的角色、CSFE 思考框架、输出风格等固化为系统提示词。  
  - 将课程信息与用户输入抽象为「信息提示词」，方便与其他 Prompt 组合。  
  - 提供 LangChain 的 `ChatPromptTemplate` 和 `format_course_messages()` 帮助函数。
- Graph 层（Graph）：
  - 使用 LangGraph 将 Prompt、LLM 调用、工具调用组成有状态的对话流程。  
  - 当前实现重点在课程助手对话，可逐步增加节点（如调用课程/作业查询工具）。
- Tool 层（Tool）：
  - 将网络搜索、课程查询、计划查询等封装为可调用工具。  
  - 在 `ai.py` 路由中通过 `/tools/available` 和 `/tools/invoke` 暴露给前端和 AI 调度。
- 语音层（TTS / STT）：
  - 在 `app/TTS` 中封装语音识别与合成（按需接入）。  
  - 供 AI 模块调用，实现语音问答与朗读。

---

## 3. 典型请求流程

### 3.1 用户登录

1. 前端调用 `POST /api/auth/login`，传入 `username`、`password`。  
2. 路由 `auth.py` 调用 `auth_service.login(db, username, password)`：  
   - 使用 `db` 查询 `User` 表；  
   - 校验密码；  
   - 生成 JWT Token；  
   - 更新 `last_login_at`。  
3. 返回 `{ success: true, data: { access_token, token_type: "bearer" } }`。

### 3.2 获取课程表

1. 前端调用 `GET /api/schedule/week?semester=2024-2025-1&week=3`。  
2. 路由 `schedule.py` 从 `course_sessions` / `courses` 中查询：  
   - 按 `user_id + semester + week` 过滤课程时间片；  
   - 聚合为 `StudentSchedule`（包含多个 `CourseSlot`）。  
3. 返回 `{ success: true, data: { student_id, slots: [...] } }`。

### 3.3 AI 聊天

1. 前端调用 `POST /api/ai/chat`，请求体为 `ChatRequestDTO`：  
   - `message`：用户输入文本  
   - `course_id`：可选，用于课程上下文  
   - `conversation_id`：可选，用于多轮对话  
2. 路由 `ai.py`：  
   - 将请求转换为 `ChatEntity`；  
   - 调用 `ai_chat_service.generate_reply(entity)`。  
3. `ai_chat_service`：  
   - 构造 `CoursePromptParams`（课程名称、目标等）；  
   - 调用 LangGraph 图或直接调用 LLM；  
   - 返回 `ChatResponse`（`success`、`data`、`conversation_id`、`tool_calls`）。  
4. 路由封装成 `ChatReplyDTO` 返回前端。

---

## 4. 与前端 / 设计文档的对应关系

- 与《功能原型设计.md》：  
  - 账号与认证 → `auth` / `user` 路由 + `User` 模型。  
  - 课程表模块 → `course` / `schedule` 路由 + `Course` / `CourseSession` 模型 + `CourseSlot` / `StudentSchedule` 实体。  
  - 计划模块 → 将通过新增 `Plan`、`PlanTask` 等模型和 `/api/plans/*` 路由来实现。  
  - 个人中心 → `user`、`user_ai_settings`、学习统计 `study_stats`、通知 `notifications` 等。
- 与《数据库表设计.md》：  
  - 已落地的表（如 `user`、`course`、`assignment`、`announcement`、`file_resource`、`ai_conversation`、`ai_message`）已经有对应 ORM。  
  - 新设计的表可以按文档在 `app/models` 中逐步实现。  
- 与《接口设计.md》：  
  - 路由文件与接口文档一一对应，便于前后端对齐字段和 URL。

---

> 后续若你扩展「计划模块」「标签管理」「学习统计」等，可以在本文件中新增对应的小节：说明新增的 models / routers / services，以及它们在整体架构中的位置。这样，整个项目的后端结构就能一直保持清晰、可维护。
