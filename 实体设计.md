# 实体类设计说明（ORM 实体 + DTO 实体）

> 依据：《功能原型设计.md》《数据库表设计.md》  
> 目标：给出后端主要实体类（数据库 ORM 实体 + 接口 DTO / 聚合实体）的设计草案，便于在 FastAPI / SQLAlchemy / Pydantic 中直接落地。  
> 说明：以下代码为“示例实现”，字段命名与 `数据库表设计.md` 对应；实际项目中可以按现有 `app.models.*` 逐步迁移和对齐。

---

## 一、ORM 实体（对应数据库表）

示例均以 **SQLAlchemy Declarative Base** 风格编写，便于与当前项目 `src/app/models/*.py` 保持一致。

```python
from datetime import datetime, date, time
from sqlalchemy import (
    Boolean,
    Column,
    Date,
    DateTime,
    Enum,
    ForeignKey,
    Integer,
    BigInteger,
    String,
    Text,
    Time,
    JSON,
    DECIMAL,
)
from app.core.database import Base
```

> 注：`BigInteger` 与 `Integer` 的选择可根据数据库及数据量调整，下面使用 `BigInteger` 时仅表示“可支持更大 ID 范围”。

### 1.1 用户与认证相关

#### 1.1.1 用户表 `users`

```python
class User(Base):
    __tablename__ = "users"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    username = Column(String(64), unique=True, index=True, nullable=True)
    phone = Column(String(20), unique=True, index=True, nullable=True)
    email = Column(String(128), unique=True, index=True, nullable=True)
    password_hash = Column(String(255), nullable=False)

    nickname = Column(String(64), nullable=False)
    avatar_url = Column(String(255))
    bio = Column(String(255))

    status = Column(Integer, nullable=False, default=1)  # 1=正常,0=禁用,2=注销

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.1.2 第三方账号 `user_oauth_accounts`

```python
class UserOAuthAccount(Base):
    __tablename__ = "user_oauth_accounts"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    provider = Column(String(32), nullable=False)  # qq / wechat / alipay
    open_id = Column(String(128), nullable=False)
    union_id = Column(String(128))

    access_token = Column(String(255))
    refresh_token = Column(String(255))
    expires_at = Column(DateTime)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.1.3 短信验证码 `sms_codes`

```python
class SmsCode(Base):
    __tablename__ = "sms_codes"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    phone = Column(String(20), nullable=False, index=True)
    code = Column(String(10), nullable=False)
    scene = Column(String(32), nullable=False)  # login / register / reset_password

    is_used = Column(Boolean, nullable=False, default=False)
    expired_at = Column(DateTime, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

#### 1.1.4 AI 设置 `user_ai_settings`

```python
class UserAiSettings(Base):
    __tablename__ = "user_ai_settings"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, unique=True)

    model = Column(String(64))
    temperature = Column(DECIMAL(3, 2), default=0.70)
    max_tokens = Column(Integer)
    prompt_preset = Column(String(128))
    tools_config = Column(JSON)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

---

### 1.2 课程与课程表相关

#### 1.2.1 课程 `courses`

```python
class Course(Base):
    __tablename__ = "courses"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    name = Column(String(128), nullable=False)
    teacher = Column(String(128))
    color = Column(String(16))
    remark = Column(String(255))

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.2.2 课程时间片 `course_sessions`

```python
class CourseSession(Base):
    __tablename__ = "course_sessions"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    course_id = Column(BigInteger, ForeignKey("courses.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    weekday = Column(Integer, nullable=False)  # 1=周一...7=周日
    start_time = Column(Time, nullable=False)
    end_time = Column(Time, nullable=False)
    location = Column(String(128))

    start_week = Column(Integer, nullable=False)
    end_week = Column(Integer, nullable=False)
    week_type = Column(
        Enum("all", "odd", "even", name="week_type_enum"),
        nullable=False,
        default="all",
    )
    semester = Column(String(32), nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.2.3 课程资料 `course_materials`

```python
class CourseMaterial(Base):
    __tablename__ = "course_materials"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    course_id = Column(BigInteger, ForeignKey("courses.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    file_name = Column(String(255), nullable=False)
    file_url = Column(String(512), nullable=False)
    file_type = Column(String(32))
    size = Column(BigInteger)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.2.4 课程笔记 `course_notes`

```python
class CourseNote(Base):
    __tablename__ = "course_notes"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    course_id = Column(BigInteger, ForeignKey("courses.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)
    session_id = Column(BigInteger, ForeignKey("course_sessions.id"), index=True)

    title = Column(String(255), nullable=False)
    content = Column(Text, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.2.5 课程录音 `course_recordings`

```python
class CourseRecording(Base):
    __tablename__ = "course_recordings"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    course_id = Column(BigInteger, ForeignKey("courses.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)
    session_id = Column(BigInteger, ForeignKey("course_sessions.id"), index=True)

    file_url = Column(String(512), nullable=False)
    duration_seconds = Column(Integer)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

---

### 1.3 计划 / 任务 / 日记相关

#### 1.3.1 计划 `plans`

```python
class Plan(Base):
    __tablename__ = "plans"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    title = Column(String(255), nullable=False)
    type = Column(String(32), nullable=False, default="study")
    status = Column(String(32), nullable=False, default="not_started")
    start_date = Column(Date)
    end_date = Column(Date)

    outline = Column(Text)
    remark = Column(String(255))

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.3.2 计划设定 `plan_settings`

```python
class PlanSetting(Base):
    __tablename__ = "plan_settings"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    plan_id = Column(BigInteger, ForeignKey("plans.id"), nullable=False, unique=True)

    daily_hours = Column(DECIMAL(4, 2))
    remind_time = Column(Time)
    study_goal = Column(String(255))
    main_target = Column(String(255))
    expected_result = Column(Text)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.3.3 计划任务 `plan_tasks`

```python
class PlanTask(Base):
    __tablename__ = "plan_tasks"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    plan_id = Column(BigInteger, ForeignKey("plans.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    name = Column(String(255), nullable=False)
    description = Column(Text)

    start_datetime = Column(DateTime)
    end_datetime = Column(DateTime)
    expected_days = Column(Integer)

    priority = Column(String(16), nullable=False, default="medium")
    status = Column(String(32), nullable=False, default="not_started")

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.3.4 计划日记 `plan_diaries` 与附件 `diary_attachments`

```python
class PlanDiary(Base):
    __tablename__ = "plan_diaries"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    plan_id = Column(BigInteger, ForeignKey("plans.id"), nullable=False, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    date = Column(Date, nullable=False)
    content = Column(Text)
    mood = Column(String(32))
    score = Column(Integer)
    summary = Column(String(255))

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )


class DiaryAttachment(Base):
    __tablename__ = "diary_attachments"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    diary_id = Column(BigInteger, ForeignKey("plan_diaries.id"), nullable=False, index=True)

    file_url = Column(String(512), nullable=False)
    file_name = Column(String(255))
    file_type = Column(String(32))

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

---

### 1.4 标签 / 统计 / 通知相关

#### 1.4.1 标签 `tags` 与关联 `tag_relations`

```python
class Tag(Base):
    __tablename__ = "tags"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), index=True)

    name = Column(String(64), nullable=False)
    color = Column(String(16))

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )


class TagRelation(Base):
    __tablename__ = "tag_relations"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    tag_id = Column(BigInteger, ForeignKey("tags.id"), nullable=False, index=True)

    target_type = Column(String(32), nullable=False)
    target_id = Column(BigInteger, nullable=False)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

#### 1.4.2 学习统计 `study_stats`

```python
class StudyStat(Base):
    __tablename__ = "study_stats"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    date_range_type = Column(String(16), nullable=False)  # day/week/month/term
    date_range_start = Column(Date, nullable=False)
    date_range_end = Column(Date, nullable=False)

    total_study_minutes = Column(Integer, default=0)
    completed_plan_count = Column(Integer, default=0)
    attended_course_count = Column(Integer, default=0)
    extra_data = Column(JSON)

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

#### 1.4.3 通知 `notifications`

```python
class Notification(Base):
    __tablename__ = "notifications"

    id = Column(BigInteger, primary_key=True, autoincrement=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)

    type = Column(String(32), nullable=False)  # course_reminder / plan_reminder / system
    title = Column(String(255), nullable=False)
    content = Column(Text, nullable=False)

    related_type = Column(String(32))
    related_id = Column(BigInteger)

    scheduled_at = Column(DateTime)
    sent_at = Column(DateTime)
    status = Column(String(16), nullable=False, default="pending")

    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )
```

---

### 1.5 AI 对话相关（已在 `app.models.ai` 中实现，可作为设计参考）

```python
class AiConversation(Base):
    __tablename__ = "ai_conversation"

    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("users.id"), nullable=False, index=True)
    role_scope = Column(String(20), nullable=False)  # student / admin / other role
    course_id = Column(Integer, ForeignKey("courses.id"))
    title = Column(String(255))
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(
        DateTime,
        default=datetime.utcnow,
        onupdate=datetime.utcnow,
        nullable=False,
    )


class AiMessage(Base):
    __tablename__ = "ai_message"

    id = Column(Integer, primary_key=True, index=True)
    conversation_id = Column(
        Integer,
        ForeignKey("ai_conversation.id"),
        nullable=False,
        index=True,
    )
    sender_type = Column(String(20), nullable=False)  # user / assistant / system / tool
    content = Column(Text, nullable=False)
    tool_name = Column(String(100))
    meta = Column(JSON)  # 如：模型名、token 数、耗时等
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
```

---

## 二、DTO / Pydantic 实体（接口与聚合实体）

本节用于描述 HTTP 接口层与前端交互的实体，通常使用 Pydantic 或 `dataclasses`，不直接映射数据库表。

```python
from typing import List, Optional, Any
from datetime import datetime, date, time
from pydantic import BaseModel, Field, EmailStr
```

### 2.1 用户与 AI 设置 DTO

```python
class UserProfileDTO(BaseModel):
    id: int
    username: str
    nickname: str
    email: Optional[EmailStr] = None
    phone: Optional[str] = None
    role: str


class UpdateUserProfileDTO(BaseModel):
    nickname: Optional[str] = None
    email: Optional[EmailStr] = None
    phone: Optional[str] = None


class UserAiSettingsDTO(BaseModel):
    model: Optional[str] = None
    temperature: float = 0.7
    max_tokens: Optional[int] = None
    prompt_preset: Optional[str] = None
    tools_config: Optional[dict] = None
```

---

### 2.2 课程与课程表 DTO

```python
class CourseDTO(BaseModel):
    id: int
    name: str
    teacher: Optional[str] = None
    color: Optional[str] = None
    remark: Optional[str] = None


class CourseSessionDTO(BaseModel):
    id: int
    course_id: int
    weekday: int
    start_time: time
    end_time: time
    location: Optional[str] = None
    start_week: int
    end_week: int
    week_type: str
    semester: str


class CourseMaterialDTO(BaseModel):
    id: int
    file_name: str
    file_url: str
    file_type: Optional[str] = None
    size: Optional[int] = None
    created_at: datetime
```

课程表聚合实体（与 `src/app/Data/Entity/CourseSlot.py` / `StudentSchedule.py` 对齐）：

```python
class CourseSlot(BaseModel):
    course_id: int
    course_title: str
    weekday: int
    start_time: time
    end_time: time
    location: Optional[str] = None


class StudentScheduleDTO(BaseModel):
    student_id: int
    week_index: Optional[int] = None
    slots: List[CourseSlot]
```

---

### 2.3 计划 / 任务 / 日记 DTO

```python
class PlanDTO(BaseModel):
    id: int
    title: str
    type: str
    status: str
    start_date: Optional[date] = None
    end_date: Optional[date] = None
    outline: Optional[str] = None
    remark: Optional[str] = None


class PlanSettingDTO(BaseModel):
    daily_hours: Optional[float] = None
    remind_time: Optional[time] = None
    study_goal: Optional[str] = None
    main_target: Optional[str] = None
    expected_result: Optional[str] = None


class PlanTaskDTO(BaseModel):
    id: int
    plan_id: int
    name: str
    description: Optional[str] = None
    start_datetime: Optional[datetime] = None
    end_datetime: Optional[datetime] = None
    expected_days: Optional[int] = None
    priority: str
    status: str
```

日记相关：

```python
class DiaryAttachmentDTO(BaseModel):
    id: int
    file_url: str
    file_name: Optional[str] = None
    file_type: Optional[str] = None


class PlanDiaryDTO(BaseModel):
    id: int
    plan_id: int
    date: date
    content: Optional[str] = None
    mood: Optional[str] = None
    score: Optional[int] = None
    summary: Optional[str] = None
    attachments: List[DiaryAttachmentDTO] = Field(default_factory=list)
```

---

### 2.4 标签 / 统计 / 通知 DTO

```python
class TagDTO(BaseModel):
    id: int
    name: str
    color: Optional[str] = None


class StudyStatsDTO(BaseModel):
    total_study_minutes: int
    completed_plan_count: int
    attended_course_count: int
    extra_data: Optional[dict] = None


class NotificationDTO(BaseModel):
    id: int
    type: str
    title: str
    content: str
    related_type: Optional[str] = None
    related_id: Optional[int] = None
    scheduled_at: Optional[datetime] = None
    sent_at: Optional[datetime] = None
    status: str
```

---

### 2.5 AI 对话 DTO（与 `src/app/Data/Entity` 现有实现对齐）

当前项目已在 `src/app/Data/Entity` 中定义了对话相关的 dataclass，这里给出 Pydantic 风格的等价模型，便于在接口层使用：

```python
class ChatMessageDTO(BaseModel):
    role: str  # "user" | "assistant" | "system" | "tool"
    content: str


class ChatRequestDTO(BaseModel):
    conversation_id: Optional[str] = None
    course_id: Optional[int] = None
    message: str


class ChatReplyDTO(BaseModel):
    conversation_id: str
    reply: str
    tool_calls: Optional[List[dict]] = None
```

> 实际代码中你已经有 `ChatEntity` / `ChatRequestDTO` / `ChatReplyDTO` 等 dataclass，本节更多是从“接口设计”的角度给它们一个统一的描述。  
> 后续如果要接 LangGraph / LangChain，可以直接在这些 DTO 的基础上组装 messages 与上下文。 

