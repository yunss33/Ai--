# 接口设计说明（后端 API 草案）

> 依据：《功能原型设计.md》《数据库表设计.md》  
> 风格：RESTful，统一以 `/api` 为前缀；认证采用 JWT Bearer Token。  
> 说明：本文件用于约束接口形态，与实际实现可能存在少量差异，后续以代码为准迭代同步。

---

## 1. 通用约定

### 1.1 基本信息

- 基础路径：`/api`
- 认证方式：HTTP Header `Authorization: Bearer <access_token>`
- 数据格式：`application/json`

### 1.2 返回结构约定

统一使用包裹结构（与前端双层 `data` 约定保持一致）：

```json
{
  "success": true,
  "data": {
    "xxx": "具体业务数据",
    "items": [],
    "total": 0
  },
  "error": {
    "code": "可选的错误码",
    "message": "可选的错误信息"
  }
}
```

- 正常成功：`success = true`，`data` 内包含业务字段，`error = null` 或不返回。
- 业务失败：`success = false`，HTTP 状态码与错误类型一致，`error` 填充错误信息。

### 1.3 分页约定

查询列表统一支持：

- 请求参数：
  - `page`: 第几页（从 1 开始）
  - `page_size`: 每页数量（默认 10，最大 100）
- 返回：
  - `data.items`: 当前页数据数组
  - `data.total`: 总记录数

---

## 2. 认证与用户信息接口

对应数据库表：`users`、`user_oauth_accounts`、`user_ai_settings`。
实际路由文件：`src/app/routers/auth.py`、`src/app/routers/user.py`。

### 2.1 用户注册

- 方法：`POST /api/auth/register`
- 请求体：
  - `username`: string，必填
  - `password`: string，必填
  - `confirm_password`: string，必填
  - `real_name`: string，必填
  - `email`: string，必填，邮箱格式
  - `phone`: string，可选
- 响应数据 `data`：
  - `access_token`: string
  - `token_type`: `"bearer"`

### 2.2 用户登录

- 方法：`POST /api/auth/login`
- 请求体：
  - `username`: string
  - `password`: string
- 响应数据 `data`：
  - `access_token`: string
  - `token_type`: `"bearer"`

### 2.3 当前用户信息

- 方法：`GET /api/auth/me`
- 认证：需要
- 响应数据 `data`：
  - `id`: number
  - `username`: string
  - `real_name`: string
  - `email`: string | null
  - `phone`: string | null
  - `role`: `"student"` | `"admin"`

### 2.4 个人资料查看 / 修改

- 查看资料：
  - 方法：`GET /api/user/profile`
  - 响应数据 `data`：
    - `id`、`username`、`real_name`、`role`、`email`、`phone`
- 修改资料：
  - 方法：`PUT /api/user/profile`
  - 请求体（全部可选）：
    - `real_name`: string
    - `email`: string
    - `phone`: string
  - 响应数据 `data`：更新后的用户信息

### 2.5 AI 设置（个人）

对应表：`user_ai_settings`。

- 获取设置：
  - 方法：`GET /api/user/ai-settings`
  - 响应数据 `data`：
    - `model`: string
    - `temperature`: number
    - `max_tokens`: number | null
    - `prompt_preset`: string | null
    - `tools_config`: object | null
- 更新设置：
  - 方法：`PUT /api/user/ai-settings`
  - 请求体字段与返回数据结构一致，全部可选。

---

## 3. 课程与课程表接口

对应表：`courses`、`course_sessions`、`course_materials`、`course_notes`、`course_recordings`。
实际路由：`src/app/routers/course.py`、`src/app/routers/schedule.py`。

### 3.1 课程列表 / 详情

- 课程列表：
  - 方法：`GET /api/courses`
  - 查询参数：
    - `semester`: string，可选，学期标识（如 `2024-2025-1`）
  - 响应数据 `data.items`：
    - `id`: number
    - `name`: string
    - `teacher`: string
    - `color`: string
    - `remark`: string
- 课程详情：
  - 方法：`GET /api/courses/{course_id}`
  - 响应数据 `data`：
    - 课程基本信息 + 关联统计（如作业数量、资料数量，可在实现时按需补充）

### 3.2 课程时间片 / 课程表

- 获取某课程的时间片：
  - 方法：`GET /api/courses/{course_id}/sessions`
  - 响应数据 `data.items`：
    - `id`
    - `weekday`：1–7
    - `start_time` / `end_time`
    - `location`
    - `start_week` / `end_week`
    - `week_type`：`all` / `odd` / `even`
    - `semester`

- 获取学生某周课程表（按课程表视图）：
  - 方法：`GET /api/schedule/week`
  - 查询参数：
    - `semester`: string
    - `week`: number
  - 响应数据 `data`：
    - `student_id`: number
    - `slots`: 数组，每个元素：
      - `course_id`
      - `course_title`
      - `weekday`
      - `start_time` / `end_time`
      - `location`

> 注：当前项目已有 `GET /api/schedule/sample` 用于示例，未来可扩展为上述真实实现。

### 3.3 课程资料 / 笔记 / 录音

- 课程资料列表：
  - 方法：`GET /api/courses/{course_id}/materials`
  - 响应数据 `data.items`：
    - `id`, `file_name`, `file_url`, `file_type`, `size`, `created_at`

- 上传课程资料：
  - 方法：`POST /api/courses/{course_id}/materials`
  - 请求：`multipart/form-data`，包含文件字段 `file`。
  - 响应：新建资料记录。

- 课程笔记列表：
  - 方法：`GET /api/courses/{course_id}/notes`
  - 查询参数：`session_id` 可选
  - 响应数据 `data.items`：
    - `id`, `title`, `created_at`, `session_id`

- 创建 / 修改 / 删除课程笔记：
  - `POST /api/courses/{course_id}/notes`
  - `PUT /api/course-notes/{note_id}`
  - `DELETE /api/course-notes/{note_id}`

- 课程录音列表与上传：
  - 类似资料接口：
    - `GET /api/courses/{course_id}/recordings`
    - `POST /api/courses/{course_id}/recordings`

---

## 4. 作业与公告接口

对应表（未来可扩展为实际表）：`assignments`、`assignment_submissions`、`announcements`。  
实际路由：`src/app/routers/assignment.py`、`src/app/routers/announcement.py`。

### 4.1 作业相关

- 获取课程作业列表：
  - 方法：`GET /api/courses/{course_id}/assignments`
  - 响应数据 `data.items`：
    - `id`, `course_id`, `title`, `description`

- 获取单个作业详情：
  - 方法：`GET /api/assignments/{assignment_id}`
  - 响应数据 `data`：作业基本信息 + 截止时间等（实现时可补充）。

- 提交作业：
  - 方法：`POST /api/assignments/{assignment_id}/submissions`
  - 请求体：
    - `content`: string（文本答案）
    - 未来可扩展附件：`files`
  - 响应数据 `data`：
    - `id`, `assignment_id`, `student_id`, `content`, `created_at`

### 4.2 公告相关

- 获取公告列表：
  - 方法：`GET /api/announcements`
  - 查询参数：
    - `course_id`: 可选，只看某门课的公告
  - 响应数据 `data.items`：
    - `id`, `course_id`, `title`, `content`, `created_at`

---

## 5. 计划 / 任务 / 日记接口

对应表：`plans`、`plan_settings`、`plan_tasks`、`plan_diaries`、`diary_attachments`、`study_stats`。

### 5.1 计划列表 / 详情

- 计划列表：
  - 方法：`GET /api/plans`
  - 查询参数：
    - `type`: 可选（study / project / life / other）
    - `status`: 可选
    - `start_date` / `end_date`: 可选，按时间范围筛选
    - 分页参数
  - 响应数据 `data.items`：
    - `id`, `title`, `type`, `status`, `start_date`, `end_date`, `created_at`

- 创建计划：
  - 方法：`POST /api/plans`
  - 请求体：
    - `title`, `type`, `start_date`, `end_date`, `outline`, `remark`
  - 响应数据 `data`：新建计划详情

- 获取计划详情：
  - 方法：`GET /api/plans/{plan_id}`
  - 响应数据 `data`：
    - 计划基本信息 + 设定摘要 + 任务统计（可在实现时补充）

- 更新 / 删除计划：
  - `PUT /api/plans/{plan_id}`
  - `DELETE /api/plans/{plan_id}`

### 5.2 计划设定

- 方法：`GET /api/plans/{plan_id}/settings`
- 方法：`PUT /api/plans/{plan_id}/settings`
- 字段：
  - `daily_hours`, `remind_time`, `study_goal`, `main_target`, `expected_result`

### 5.3 计划任务

- 获取计划下任务列表：
  - 方法：`GET /api/plans/{plan_id}/tasks`
  - 查询参数：
    - `status`, `priority` 可选
  - 响应数据 `data.items`：
    - `id`, `name`, `start_datetime`, `end_datetime`, `priority`, `status`

- 创建 / 更新 / 删除任务：
  - `POST /api/plans/{plan_id}/tasks`
  - `PUT /api/plan-tasks/{task_id}`
  - `DELETE /api/plan-tasks/{task_id}`

### 5.4 日历视图与日记

- 获取某计划在日历上的分布：
  - 方法：`GET /api/plans/{plan_id}/calendar`
  - 查询参数：
    - `month`: 可选 （例如 "2025-03"）
  - 响应数据 `data.items`：
    - 每天对应的任务数量 / 学习时长等摘要。

- 获取某天日记：
  - 方法：`GET /api/plans/{plan_id}/diaries/{date}`
  - 响应数据 `data`：
    - `id`, `content`, `mood`, `score`, `summary`, 及附件列表

- 创建 / 更新 / 删除日记：
  - `POST /api/plans/{plan_id}/diaries`
  - `PUT /api/plan-diaries/{diary_id}`
  - `DELETE /api/plan-diaries/{diary_id}`

### 5.5 学习统计

- 方法：`GET /api/stats/study`
- 查询参数：
  - `range_type`: day / week / month / term
  - `start` / `end`: 可选
- 响应数据 `data`：
  - 对应 `study_stats` 中的聚合结果：`total_study_minutes`、`completed_plan_count` 等。

---

## 6. 标签接口

对应表：`tags`、`tag_relations`。

- 获取标签列表：
  - 方法：`GET /api/tags`
  - 响应数据 `data.items`：
    - `id`, `name`, `color`, `created_at`

- 创建 / 更新 / 删除标签：
  - `POST /api/tags`
  - `PUT /api/tags/{tag_id}`
  - `DELETE /api/tags/{tag_id}`

- 为对象设置标签（可选实现方式一）：
  - 方法：`POST /api/tags/bind`
  - 请求体：
    - `tag_id`, `target_type`, `target_id`

- 也可以在具体对象接口中直接传递标签 ID 数组完成绑定（如在创建任务时传 `tag_ids`），由服务层写入 `tag_relations`。

---

## 7. AI 助手接口

对应表：`user_ai_settings`、`notifications`，以及 AI 会话相关实体（目前主要在内存或外部存储中管理）；  
实际路由：`src/app/routers/ai.py`。

### 7.1 聊天接口

- 方法：`POST /api/ai/chat`
- 请求体（参考 `ChatRequestDTO`）：
  - `message`: string，用户输入
  - `course_id`: number | null，与某门课程关联时使用
  - `conversation_id`: string | null，会话标识，空表示新会话
- 响应数据 `data`（参考 `ChatReplyDTO`）：
  - `conversation_id`: string
  - `reply`: string（AI 文本回复）
  - `tool_calls`: array（AI 工具调用记录，结构视实现而定）

> 若未来接入 WebSocket 流式输出，可以复用此接口的入参，只改变传输协议。

### 7.2 会话与消息历史（预留）

- 获取会话列表：
  - 方法：`GET /api/ai/conversations`
  - 响应数据 `data.items`：
    - `id`, `title`, `course_id`

- 获取某会话消息列表：
  - 方法：`GET /api/ai/conversations/{conversation_id}/messages`
  - 响应数据 `data.items`：
    - `id`, `sender_type`（user/assistant/tool）, `content`

> 当前实现返回空数组，未来可基于数据库表或外部向量库实现。

### 7.3 工具列表与调用

- 获取可用工具列表：
  - 方法：`GET /api/ai/tools/available`
  - 响应数据 `data.items`：
    - `name`, `description`

- 调用工具：
  - 方法：`POST /api/ai/tools/invoke`
  - 请求体：
    - `tool_name`: string
    - `params`: object
  - 响应数据 `data`：
    - `tool_name`
    - `result`: any（工具执行结果）或 `error`

---

> 后续如果你增加新的模块（例如“课程提醒管理”“系统配置”等），可以按同样的格式在本文件中继续扩展接口定义：说明 URL、方法、请求体、返回数据结构及与哪些数据库表相关联即可。 

